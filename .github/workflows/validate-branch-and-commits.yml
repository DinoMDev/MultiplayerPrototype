name: branch-commit-policy

on:
  pull_request:
    branches: [ main ]  # PRs into main only; no push trigger = no duplicate runs

jobs:
  branch-commit-policy:
    name: branch-commit-policy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        shell: bash
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          if [[ ! "$BRANCH_NAME" =~ ^(feat|fix|chore|refactor)\/[a-z0-9._-]+$ ]]; then
            echo "❌ Invalid branch name: $BRANCH_NAME"
            echo "   Required: feat/<name> | fix/<name> | chore/<topic> | refactor/<topic>"
            exit 1
          fi
          echo "✅ Branch OK: $BRANCH_NAME"

      - name: Validate commit messages
        shell: bash
        run: |
          # Compare PR head against main. Assumes origin/main exists from checkout -- fetch-depth: 0
          COMMITS=$(git log --no-merges --pretty=%s origin/main..HEAD || true)
          if [[ -z "$COMMITS" ]]; then
            echo "ℹ️ No new commits vs main (rebased or empty)"; exit 0
          fi

          BAD=$(echo "$COMMITS" | grep -Ev '^(feat|fix|chore|refactor)\([a-z0-9._-]+\): .+' || true)
          if [[ -n "$BAD" ]]; then
            echo "❌ Bad commit subjects detected:"
            echo "$BAD"
            echo
            echo "Format: <type>(<scope>): <message>"
            echo "Types: feat | fix | chore | refactor"
            exit 1
          fi
          echo "✅ Commit messages OK"